<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <link href="css/bootstrap-4.3.1.css" rel="stylesheet" type="text/css">
    <link href="css/vuetify.min.css" rel="stylesheet">
    <link href="css/materialdesignicons.min.css" rel="stylesheet">
    <script src="js/jquery-3.5.1.slim.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap-4.3.1.js" type="text/javascript"></script>
    <script src="js/vue.js"></script>
    <script src="js/vuetify.js"></script>
    <script src="js/Sortable.min.js"></script>
    <script src="js/vuedraggable.umd.min.js"></script>
    <script src="js/fftanalyzer.js"></script>
    <title>Le player - now revised</title>
    <style>
        #visualizer {
            z-index: 0;
            height: 100vh;
        }

        .lyrics-holder {
            width: auto;
            position: fixed;
            margin-top: 0%;
            right: 10%;
            top: 10%;
        }

        .lyric-0,
        .lyric-1,
        .lyric-2 {
            font-size: 4em;
            font-weight: 400;
            color: white !important;
            font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;
        }

        .lyric-1 {
            font-size: 2em;
        }

        .lyric-2 {
            font-size: 2em;
        }

        .lyrics-b {
            opacity: 50%;
        }
    </style>

</head>

<body>
    <audio id="player"></audio>
    <div id="app">
        <v-app>
            <canvas id="visualizer"></canvas>
            <div class="lyrics-holder" v-if="parsedLyrics">
                <div class="lyrics-a">
                    <p v-for="(lyric,index) in this.lyricsAt(this.matchedIndex - 1)" :class="'lyric-'+index">{{lyric}}
                    </p>
                </div>
                <div class="lyrics-b">
                    <p v-for="(lyric,index) in this.lyricsAt(this.matchedIndex)" :class="'lyric-'+index">{{lyric}}</p>
                </div>
            </div>
            <v-dialog max-width="50%" v-model="error">
                <v-card>
                    <v-card-title>
                        <span class="headline">Track Fetch Error</span>
                    </v-card-title>
                    <v-card-text>
                        <div class="text-h2 pa-12">{{ lastError }}</div>
                    </v-card-text>
                </v-card>
            </v-dialog>

            <v-dialog style="background: white;" max-width="50%" v-model="trackConflictDialog">
                <v-card>
                    <v-card-title>
                        <span class="headline">Track Conflict</span>
                    </v-card-title>
                    <v-alert border="right" colored-border type="error" elevation="2">
                        The following tracks were not added as they already exist:
                    </v-alert>
                    <v-spacer></v-spacer>
                    <v-list>
                        <v-list-item v-for="track in existTracks" :key="track.id">
                            {{track.name}} - {{track.ar.map(f=>f.name).join('-')}} - {{track.al.name}}
                        </v-list-item>
                    </v-list>
                </v-card>
            </v-dialog>

            <v-bottom-navigation fixed grow height="80">
                <v-dialog inset hide-overlay>
                    <template v-slot:activator="{ on }">
                        <v-btn v-on="on">
                            <span>Settings</span>
                            <v-icon>mdi-account-settings</v-icon>
                        </v-btn>
                    </template>
                    <v-toolbar dark prominent src="images/banner.jpg">
                        <v-toolbar-title>Settings</v-toolbar-title>
                    </v-toolbar>
                    <v-spacer></v-spacer>
                    <v-card style="background: white;" class="text-h5 pa-12">don't have any, go away</v-card>
                </v-dialog>
                <v-card v-if="currentTrack" tile grow width="100%">
                    <v-slider class="large-slider" style="height: 1em;" :value="currentTime" :max="duration" absolute
                        class="my-0 py-0" @change="seekTrack">
                    </v-slider>
                    <v-list>
                        <v-list-item>
                            <v-list-item-content>
                                <v-list-item-title>{{ currentTrack.name }}</v-list-item-title>
                                <v-list-item-subtitle>
                                     {{currentTrack.ar.map(f=>f.name).join('-')}} - {{currentTrack.al.name}}
                                </v-list-item-subtitle>
                            </v-list-item-content>
                            <v-spacer></v-spacer>
                            <v-list-item-icon>
                                <v-btn icon @click="opearteTrack('rewind')">
                                    <v-icon>mdi-rewind</v-icon>
                                </v-btn>
                            </v-list-item-icon>
                            <v-list-item-icon :class="{ 'mx-5': $vuetify.breakpoint.mdAndUp }">
                                <v-btn icon @click="opearteTrack('pause')">
                                    <v-icon>mdi-pause</v-icon>
                                </v-btn>
                            </v-list-item-icon>
                            <v-list-item-icon class="ml-0" :class="{ 'mr-3': $vuetify.breakpoint.mdAndUp }">
                                <v-btn icon @click="opearteTrack('forward')">
                                    <v-icon>mdi-fast-forward</v-icon>
                                </v-btn>
                            </v-list-item-icon>
                        </v-list-item>
                    </v-list>

                </v-card>
                <v-dialog v-model="loading" hide-overlay persistent width="300">
                    <v-card color="primary" dark>
                        <v-card-text>
                            {{ loadInfo }}
                            <v-progress-linear indeterminate color="white" class="mb-0"></v-progress-linear>
                        </v-card-text>
                    </v-card>
                </v-dialog>
                <v-dialog max-width="80%" inset hide-overlay>
                    <template v-slot:activator="{ on }">
                        <v-btn v-on="on">
                            <span>Playlist</span>
                            <v-icon>mdi-animation-play</v-icon>
                        </v-btn>
                    </template>
                    <v-toolbar dark prominent src="images/banner.jpg">
                        <v-toolbar-title>Playlist</v-toolbar-title>
                        <v-spacer></v-spacer>
                        <v-menu top close-on-content-click>
                            <template v-slot:activator="{ on }">
                                <v-app-bar-nav-icon v-on="on"></v-app-bar-nav-icon>
                            </template>
                            <v-list>
                                <v-dialog max-width="80%">
                                    <template v-slot:activator="{ on }">
                                        <v-list-item v-on="on">
                                            <v-icon>mdi-cloud-search</v-icon>
                                            <v-list-item-title>Add via Search</v-list-item-title>
                                        </v-list-item>
                                    </template>
                                    <v-card v-if="!loading">
                                        <v-spacer></v-spacer>
                                        <v-text-field label="Search" @input="queryString=$event" class="mx-4">
                                        </v-text-field>
                                        <v-list>
                                            <v-list-item v-if="searchResults" v-for="track in searchResults"
                                                :key="track.id" @click="addTrack(track.id.toString())">
                                                <v-list-item-content>
                                                    {{track.name}} - {{track.ar.map(f=>f.name).join('-')}} - {{track.al.name}}</v-list-item-content>
                                            </v-list-item>
                                        </v-list>
                                    </v-card>
                                </v-dialog>

                                <v-dialog>
                                    <template v-slot:activator="{ on }">
                                        <v-list-item v-on="on">
                                            <v-icon>mdi-earth</v-icon>
                                            <v-list-item-title>Add via URL</v-list-item-title>
                                        </v-list-item>
                                    </template>
                                    <v-card v-if="!loading">
                                        <v-card-title>
                                            <span class="headline">Add tracks</span>
                                        </v-card-title>
                                        <v-text-field @input="newURL=$event" class="pa-2"
                                            label="URL (.e.g. https://music.163.com/#/song?id=66282)" required>
                                        </v-text-field>
                                        </v-card-actions>
                                        <v-card-actions class="justify-end">
                                            <v-btn text @click="addTrack(newURL)" :disabled="loading">OK</v-btn>
                                        </v-card-actions>
                                    </v-card>
                                </v-dialog>
                            </v-list>
                        </v-menu>
                    </v-toolbar>
                    <v-card v-if="!playlist.length" style="background: white;" class="text-h5 pa-12">
                        * Items to be added
                    </v-card>
                    <draggable v-if="playlist.length" class="v-list" style="background: white;" ghost-class="ghost"
                        @start="drag=true" @end="drag=false">
                        <v-list-item v-for="track in playlist" :key="track.id" @click="setPlay(track)">
                            <v-list-item-content>{{track.name}} - {{track.ar.map(f=>f.name).join('-')}}
                            </v-list-item-content>
                        </v-list-item>
                    </draggable>
                </v-dialog>
            </v-bottom-navigation>
        </v-app>
    </div>
</body>
<script>
    var ffta_settings = {
        'barStyle': ['#e2f1f8', '#e2f1f8', '#e2f1f8', '#b0bec5', '#b0bec5', '#b0bec5', '#808e95', '#808e95'],
        'spacing': 2,
        'ratio': 0.7,
        'fftSize': 512,
        'threshold': 3,
        'range_l': 0,
        'range_r': 0.3,
        'accel': 0.95,
        'apush': 30,
        'sequence': () => {
            draw_bass_response()
            draw_bars();
        }
    }
    const SEARCH_DEBOUNCE = 1000;
</script>
<script>
    function check_arg() {
        var target = arguments[0];
        for (var i = 1; i < arguments.length; i++)
            if (target.search(arguments[i]) >= 0) return arguments[i]
        return undefined
    }

    function search(val, src, l, r) {
        if (r == undefined) {
            l = 0;
            r = src.length
        }
        var pivot = (l + r) >> 1
        if (l >= r || pivot == l || pivot == r) return pivot
        in_between = (pivot <= 0 || (src[pivot - 1] <= val)) && val <= src[pivot]
        if (in_between)
            if (src[pivot] == val)
                return pivot
        else if (src[pivot - 1] == val)
            return pivot - 1
        else
            return pivot
        if (src[pivot] < val)
            return search(val, src, pivot, r)
        else return search(val, src, l, pivot)
    }

    function convertFromTimestamp(timestamp) {
        // this will covert LRC timestamp to seconds
        try {
            var mm = timestamp.split(':')[0]
            var ss = timestamp.split(':')[1]
            var xx = ss.split('.')[1]
            ss = ss.split('.')[0]
            return (mm * 60) + ss * 1 + (xx * Math.pow(0.1, xx.length))
        } catch (error) {
            console.error(error)
            return 0
        }
    }

    function parseLryics(lrc, tlrc) {
        const lrc_regex = /^(?:\[)(.*)(?:\])(.*)/gm;
        lyrics = {}

        function addMatches(lrc_string) {
            while ((match = lrc_regex.exec(lrc_string)) !== null) {
                if (match.index === lrc_regex.lastIndex) lrc_regex.lastIndex++
                // This is necessary to avoid infinite loops with zero-width matches
                timestamp = match[1]
                if (timestamp.indexOf('.') == -1) timestamp += '.000'
                // Pad with 0ms if no milliseconds is defined
                // match[1] contains the first capture group
                timestamp = convertFromTimestamp(timestamp)
                if (!lyrics[timestamp.toString()]) {
                    lyrics[timestamp.toString()] = [match[2]]
                } else {
                    lyrics[timestamp.toString()].push(match[2])
                }
                // Where match[2] contains the second capture group
            }
        }
        for (arg of arguments) addMatches(arg)
        return lyrics
    }
</script>
<script>
    const id_regex = /\d{5,}/gm;
    var vue = new Vue({
        el: '#app',
        vuetify: new Vuetify(),
        data: () => ({
            newURL: '',

            currentAudio: null,
            currentTrack: null,
            playlist: [],

            loading: false,
            loadInfo: 'Please stand by',

            existTracks: [],
            trackConflictDialog: false,

            lastError: null,
            error: false,

            audioConfig: {
                bitrate: 320000
            },

            currentTime: 0,
            duration: 0,

            player: document.getElementById('player'),

            currentLyrics: [],
            matchedIndex: 0,
            parsedLyrics: null,

            searchResults: null,
            queryString: null
        }),
        watch: {
            currentLyrics: (new_, old_) => {
                if (!new_) return
                vue.parsedLyrics = parseLryics(new_.lrc.lyric, new_.romalrc.lyric, new_.tlyric.lyric)
                console.log('Parsed', vue.parsedLyrics)
            },
            queryString: (new_, old_) => {
                if (this.queryTimeout)
                    clearTimeout(this.queryTimeout)
                this.queryTimeout = setTimeout(() => {
                    // querying the result
                    vue.loadInfo = 'Searching'
                    vue.loading = true
                    console.log('[search] searching', vue.queryString)
                    fetch('pyncm/cloudsearch/GetSearchResult?' + new URLSearchParams(Object.assign({
                        keyword: vue.queryString
                    }))).then(response => response.json()).then(
                        data => {
                            vue.loading = false
                            if (!data.result || !data.result.songs) return
                            console.log('[search] results', data.result.songs)
                            vue.searchResults = data.result.songs
                        }).catch(err => {
                        vue.loading = false
                    })
                }, SEARCH_DEBOUNCE)
            }
        },
        methods: {
            setPlay: (evt) => {
                if (!evt) return
                vue.currentTrack = evt
                vue.loadInfo = 'Fetching track audio'
                vue.loading = true
                fetch('pyncm/track/GetTrackAudio?' + new URLSearchParams(Object.assign({
                    song_ids: evt.id
                }, vue.audioConfig))).then(response => response.json()).then(data => {
                    track = data.data[0]
                    console.log(`[track] audio fetched. bitrate is ${track.br}`, track)
                    vue.currentLyrics = null
                    vue.currentAudio = track
                    // setup the player
                    vue.player.src = track.url
                    vue.player.play()
                    vue.loading = false
                }).catch(err => {
                    vue.loading = false
                    vue.lastError = err
                    vue.error = true
                }).then(data => {
                    fetch('pyncm/track/GetTrackLyrics?' + new URLSearchParams(Object.assign({
                        song_id: evt.id
                    }))).then(response => response.json()).then(
                        data => {
                            console.log(`[lyrics] lyrics fetched for ${evt.id}`, data)
                            vue.currentLyrics = data
                        }
                    )
                })
            },
            seekTrack: (pos) => {
                vue.player.currentTime = pos
            },
            opearteTrack: (dir) => {
                var index = vue.playlist.indexOf(vue.currentTrack)
                var operation = {
                    forward: () => index++,
                    pause: () => {
                        return vue.player.pause()
                    },
                    rewind: () => index--,
                } [dir]()
                index = index % vue.playlist.length
                vue.currentTrack = vue.playlist[index]
                vue.setPlay(vue.currentTrack)
            },
            addTrack: (url) => {
                console.log(url)
                var route, params
                ids=[]
                while ((m = id_regex.exec(url)) !== null) {
                    // This is necessary to avoid infinite loops with zero-width matches
                    if (m.index === id_regex.lastIndex) id_regex.lastIndex++
                    m.forEach(function (match, groupIndex) {
                        ids.push(match)
                    });
                }
                var match = ids
                if (!match) {
                    vue.lastError = 'No applicable IDs found'
                    vue.error = true
                }
                match = match[0]
                // parsing ids,only picking up first match
                route = 'track/GetTrackDetail'
                params = {
                    song_ids: match
                }
                if (check_arg(url, 'list')) {
                    route = 'playlist/GetPlaylistInfo'
                    params = {
                        playlist_id: match
                    }
                } else if (check_arg(url, 'album')) {
                    route = 'album/GetAlbumInfo'
                    params = {
                        album_id: match
                    }
                }
                console.log(`[multi] adding ${match} ${route}`)
                vue.loadInfo = 'Fetching tracks'
                vue.loading = true;
                fetch(`pyncm/${route}?` + new URLSearchParams(params)).then(response => response.json())
                    .then(data => {
                        var newTracks, existTracks;
                        if (data.playlist) data.songs = data.playlist.tracks
                        newTracks = data.songs.filter(track => !vue.playlist.map(track => track.id)
                            .includes(track.id))
                        if (newTracks.length != data.songs.length)
                            existTracks = data.songs.filter(track => vue.playlist.map(track => track.id)
                                .includes(track.id))
                        vue.existTracks = existTracks
                        if (existTracks) vue.trackConflictDialog = true
                        vue.playlist.push(...newTracks)
                        if (!vue.currentTrack) vue.setPlay(vue.playlist[0])
                        vue.loading = false
                    }).catch(error => {
                        vue.lastError = error
                        vue.loading = false
                        vue.error = true
                    })
            },
            lyricsAt: index => vue.parsedLyrics[Object.keys(vue.parsedLyrics)[index]],
        }
    })
    vue.player.onended = () => {
        vue.opearteTrack('forward')
    }
    vue.player.ontimeupdate = () => {
        vue.duration = vue.player.duration
        vue.currentTime = vue.player.currentTime
        vue.matchedIndex = search(vue.currentTime, Object.keys(vue.parsedLyrics))
    }
    vue.player.crossOrigin = "anonymous"
</script>
<script>
    peakmeter = document.getElementById('visualizer')
    audioCtx = new window.AudioContext()
    // connecting the analyzer    
    var source = audioCtx.createMediaElementSource(vue.player)
    source.connect(audioCtx.destination)
    var analyzer = audioCtx.createAnalyser()
    source.connect(analyzer)
    vue.player.addEventListener('play', function () {
        audioCtx.resume();
    });
    ffta_init(analyzer, peakmeter, peakmeter.offsetWidth, peakmeter.offsetHeight, ffta_settings)
</script>

</html>